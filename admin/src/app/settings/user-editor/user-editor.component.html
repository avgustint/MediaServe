<div class="user-editor-container">
  <div class="search-section">
    <div class="search-input-wrapper">
      <input
        type="text"
        pInputText
        class="search-input"
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
        [placeholder]="'searchUsersPlaceholder' | translate"
        styleClass="w-full"
      />
      <button *ngIf="searchTerm" class="clear-search-btn" (click)="clearSearch()" [title]="'clearSearch' | translate"></button>
    </div>
  </div>

  <div class="actions-section">
    <button class="add-button" (click)="addNewUser()" *ngIf="!editingUser && !isNewUser && hasEditUsersPermission">
      {{ 'addNewUser' | translate }}
    </button>
  </div>

  <div class="content-wrapper">
    <div class="users-list-section" *ngIf="!editingUser && !isNewUser">
      <div class="users-list">
        <div
          *ngFor="let user of filteredUsers"
          class="user-item"
          [class.clickable]="canModifyUser(user)"
          (click)="canModifyUser(user) && selectUser(user)"
        >
          <div class="user-info">
            <div class="user-name">{{ user.name }}</div>
            <div class="user-details">
              <span class="user-email">{{ user.email }}</span>
              <span class="user-separator">•</span>
              <span class="user-username">{{ user.username }}</span>
              <span class="user-separator">•</span>
              <span class="user-role">{{ getRoleName(user.role) }}</span>
            </div>
          </div>
          <button
            *ngIf="hasEditUsersPermission && canModifyUser(user)"
            class="delete-button"
            (click)="deleteUser(user); $event.stopPropagation()"
            [title]="'deleteUser' | translate"
          >
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="edit-section" *ngIf="editingUser || isNewUser">
      <div class="edit-form">
        <h2>{{ isNewUser ? ('addNewUser' | translate) : ('editUser' | translate) }}</h2>

        <div class="form-group">
          <label for="userName">{{ 'name' | translate }} *</label>
          <input
            id="userName"
            type="text"
            pInputText
            [(ngModel)]="userName"
            [placeholder]="'enterUserName' | translate"
            [readonly]="!hasEditUsersPermission"
            styleClass="w-full"
          />
        </div>

        <div class="form-group">
          <label for="userEmail">{{ 'email' | translate }} *</label>
          <input
            id="userEmail"
            type="email"
            pInputText
            name="userEmail"
            [(ngModel)]="userEmail"
            [placeholder]="'enterUserEmail' | translate"
            [readonly]="!hasEditUsersPermission"
            required
            pattern="[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*"
            #emailInput="ngModel"
            [class.p-invalid]="emailInput.invalid && emailInput.touched"
            styleClass="w-full"
          />
          <div *ngIf="emailInput.invalid && emailInput.touched" class="validation-error">
            <span *ngIf="emailInput.errors?.['required']">{{ 'emailRequired' | translate }}</span>
            <span *ngIf="emailInput.errors?.['pattern'] && !emailInput.errors?.['required']">{{ 'invalidEmail' | translate }}</span>
          </div>
        </div>

        <div class="form-group">
          <label for="userUsername">{{ 'username' | translate }} *</label>
          <input
            id="userUsername"
            type="text"
            pInputText
            [(ngModel)]="userUsername"
            [placeholder]="'enterUserUsername' | translate"
            [readonly]="!isNewUser"
            styleClass="w-full"
          />
        </div>

        <div class="form-group" *ngIf="hasEditUsersPermission">
          <label for="userPassword">{{ 'password' | translate }} {{ isNewUser ? '*' : ('(' + ('passwordLeaveBlank' | translate) + ')') }}</label>
          <p-password
            id="userPassword"
            [(ngModel)]="userPassword"
            [placeholder]="'enterPassword' | translate"
            [toggleMask]="true"
            [feedback]="false"
            styleClass="w-full"
          ></p-password>
        </div>

        <div class="form-group">
          <label for="userRole">{{ 'role' | translate }} *</label>
          <p-select
            id="userRole"
            [(ngModel)]="userRole"
            [options]="roles"
            optionLabel="name"
            optionValue="guid"
            [placeholder]="'selectRole' | translate"
            [disabled]="isRoleDisabled()"
            styleClass="w-full"
          ></p-select>
        </div>

        <div class="form-group">
          <label for="userLocale">{{ 'locale' | translate }} *</label>
          <p-select
            id="userLocale"
            [(ngModel)]="userLocale"
            [options]="localeOptions"
            optionLabel="label"
            optionValue="value"
            [placeholder]="'selectLocale' | translate"
            [disabled]="!hasEditUsersPermission"
            styleClass="w-full"
          ></p-select>
        </div>

        <div class="form-actions" *ngIf="hasEditUsersPermission">
          <button class="btn-save" (click)="saveUser()">
            <i class="fas fa-check"></i>
            <span>{{ 'save' | translate }}</span>
          </button>
          <button class="btn-cancel" (click)="cancelEdit()">
            <i class="fas fa-times"></i>
            <span>{{ 'cancel' | translate }}</span>
          </button>
        </div>
        <div class="form-actions" *ngIf="!hasEditUsersPermission">
          <button class="btn-cancel" (click)="cancelEdit()">
            <i class="fas fa-times"></i>
            <span>{{ 'close' | translate }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <app-error-popup
    *ngIf="showError"
    [message]="errorMessage"
    (close)="closeErrorPopup()"
  ></app-error-popup>

  <app-confirm-dialog
    [title]="confirmDialogTitle"
    [message]="confirmDialogMessage"
    [show]="showConfirmDialog"
    [confirmText]="'delete' | translate"
    [cancelText]="'cancel' | translate"
    confirmColor="danger"
    (confirm)="onConfirmDelete()"
    (cancel)="closeConfirmDialog()"
    (close)="closeConfirmDialog()"
  ></app-confirm-dialog>
</div>

