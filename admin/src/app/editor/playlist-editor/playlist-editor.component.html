<div class="playlist-editor-container">
  <div class="search-section">
    <div class="search-input-wrapper">
      <input
        type="text"
        pInputText
        class="search-input"
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
        [placeholder]="'searchPlaylists' | translate"
        styleClass="w-full"
      />
      <button *ngIf="searchTerm" class="clear-search-btn" (click)="clearSearch()" [title]="'clearSearch' | translate"></button>
    </div>
    <div class="search-results" *ngIf="showSearchResults">
      <div
        *ngIf="searchResults.length === 0 && searchTerm.trim().length > 0"
        class="no-results"
      >
        {{ 'noPlaylistsFound' | translate }}
      </div>
      <div
        *ngFor="let result of searchResults"
        class="search-result-item"
        (click)="onSearchResultSelect(result)"
      >
        <div class="search-result-name">{{ result.name }}</div>
        <div class="search-result-description" *ngIf="result.description">
          {{ result.description }}
        </div>
      </div>
    </div>
  </div>

  <div class="actions-section">
    <button class="add-button" (click)="addNewPlaylist()" *ngIf="!editingPlaylist && !isNewPlaylist && hasManagePlaylistsPermission()">
      {{ 'addNewPlaylist' | translate }}
    </button>
  </div>

  <div class="recent-playlists-section" *ngIf="showRecentPlaylists && !editingPlaylist && !isNewPlaylist && recentPlaylists.length > 0">
    <h3>{{ 'recentlyModified' | translate }}</h3>
    <div class="recent-playlists-list">
      <div
        *ngFor="let playlist of recentPlaylists"
        class="recent-playlist"
        (click)="loadPlaylist(playlist.guid)"
      >
        <div class="playlist-info">
          <div class="playlist-name">{{ playlist.name }}</div>
          <div class="playlist-details">
            <span class="playlist-modified" *ngIf="playlist.updated">
              {{ 'modified' | translate }}: {{ playlist.updated | localizedDate:'short' }}
            </span>
          </div>
          <div class="playlist-description" *ngIf="playlist.description">
            {{ playlist.description }}
          </div>
        </div>
        <button
          *ngIf="hasDeletePermission()"
          class="delete-playlist-btn"
          (click)="deletePlaylistFromList(playlist); $event.stopPropagation()"
          [title]="'deletePlaylist' | translate"
        >
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="edit-section" *ngIf="editingPlaylist || isNewPlaylist">
    <div class="edit-form">
      <h2>{{ isNewPlaylist ? ('addNewPlaylist' | translate) : ('editPlaylist' | translate) }}</h2>

      <div class="form-group">
        <label for="playlistName">{{ 'name' | translate }} *</label>
        <input
          id="playlistName"
          type="text"
          pInputText
          [(ngModel)]="playlistName"
          [placeholder]="'enterPlaylistName' | translate"
          styleClass="w-full"
        />
      </div>

      <div class="form-group">
        <label for="playlistDescription">{{ 'description' | translate }}</label>
        <input
          id="playlistDescription"
          type="text"
          pInputText
          [(ngModel)]="playlistDescription"
          [placeholder]="'enterPlaylistDescription' | translate"
          styleClass="w-full"
        />
      </div>

      <div class="form-group">
        <label>{{ 'libraryItems' | translate }}</label>
        
        <div class="add-item-section">
          <app-library-item-search
            [placeholder]="'searchLibraryItemsToAdd' | translate"
            [excludeGuids]="[]"
            (itemSelected)="onLibraryItemSelected($event)"
          ></app-library-item-search>
        </div>

        <div class="playlist-items-list" *ngIf="playlistItems.length > 0">
          <div *ngFor="let item of playlistItems; let i = index" class="playlist-item-row">
            <div class="item-guid-badge">{{ item.guid }}</div>
            <div class="item-info">
              <div class="item-name">{{ item.name || getLibraryItemName(item.guid) }}</div>
              <div class="item-details">
                <span class="item-type">{{ item.type || getLibraryItemType(item.guid) }}</span>
              </div>
              <div class="item-description" *ngIf="item.description">
                {{ item.description }}
              </div>
              
              <div class="item-pages-selector" *ngIf="getLibraryItemType(item.guid) === 'text' && getAvailablePages(item.guid).length > 1">
                <label>{{ 'pagesLeaveEmpty' | translate }}</label>
                <div class="pages-checkboxes">
                  <label *ngFor="let pageNum of getAvailablePages(item.guid)" class="page-checkbox-label">
                    <input
                      type="checkbox"
                      [checked]="isPageSelected(item, pageNum)"
                      (change)="togglePageSelection(item, pageNum)"
                    />
                    <span>{{ pageNum }}</span>
                  </label>
                </div>
                <div class="pages-actions">
                  <button
                    type="button"
                    class="btn-select-all"
                    (click)="selectAllPages(item)"
                  >
                    {{ 'selectAll' | translate }}
                  </button>
                  <button
                    type="button"
                    class="btn-clear-pages"
                    (click)="clearPages(item)"
                  >
                    {{ 'clearAllPages' | translate }}
                  </button>
                </div>
                <div class="pages-selected-info" *ngIf="getSelectedPagesText(item)">
                  {{ 'selected' | translate }}: {{ getSelectedPagesText(item) }}
                </div>
              </div>

              <div class="item-description-input">
                <input
                  type="text"
                  pInputText
                  [(ngModel)]="item.description"
                  [placeholder]="'descriptionOptional' | translate"
                  styleClass="w-full"
                />
              </div>
            </div>

            <div class="item-actions">
              <button
                class="move-btn"
                (click)="moveItemUp(i)"
                [disabled]="i === 0"
                [title]="'moveUp' | translate"
              >
                ↑
              </button>
              <button
                class="move-btn"
                (click)="moveItemDown(i)"
                [disabled]="i === playlistItems.length - 1"
                [title]="'moveDown' | translate"
              >
                ↓
              </button>
              <button
                class="remove-btn"
                (click)="removeItemFromPlaylist(item.guid)"
                [title]="'remove' | translate"
              >
                ×
              </button>
            </div>
          </div>
        </div>

        <div class="no-items" *ngIf="playlistItems.length === 0">
          {{ 'noItemsInPlaylist' | translate }}
        </div>
      </div>

      <div class="form-actions">
        <button class="btn-save" (click)="savePlaylist()">
          <i class="fas fa-check"></i>
          <span>{{ 'save' | translate }}</span>
        </button>
        <button class="btn-cancel" (click)="cancelEdit()">
          <i class="fas fa-times"></i>
          <span>{{ 'cancel' | translate }}</span>
        </button>
        <button 
          *ngIf="!isNewPlaylist && editingPlaylist && hasDeletePermission()" 
          class="delete-button" 
          (click)="deletePlaylist()"
        >
          {{ 'delete' | translate }}
        </button>
      </div>
    </div>
  </div>

  <app-error-popup
    [message]="errorMessage"
    [show]="showError"
    (close)="closeErrorPopup()"
  ></app-error-popup>

  <app-confirm-dialog
    [title]="confirmDialogTitle"
    [message]="confirmDialogMessage"
    [show]="showConfirmDialog"
    [confirmText]="'delete' | translate"
    [cancelText]="'cancel' | translate"
    confirmColor="danger"
    (confirm)="onConfirmDelete()"
    (cancel)="closeConfirmDialog()"
    (close)="closeConfirmDialog()"
  ></app-confirm-dialog>
</div>
