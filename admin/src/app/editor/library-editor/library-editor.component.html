<div class="library-editor-container">
  <div class="search-section">
    <div class="search-input-wrapper">
      <input
        type="text"
        class="search-input"
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
        placeholder="Search library items by name or content..."
      />
      <button *ngIf="searchTerm" class="clear-search-btn" (click)="clearSearch()" title="Clear search">
        ×
      </button>
    </div>
    <div class="search-results" *ngIf="showSearchResults">
      <div
        *ngIf="searchResults.length === 0 && searchTerm.trim().length > 0"
        class="no-results"
      >
        No library items found
      </div>
      <div
        *ngFor="let result of searchResults"
        class="search-result-item"
        (click)="onSearchResultSelect(result)"
      >
        <div class="search-result-name">{{ result.name }}</div>
        <div class="search-result-type">Type: {{ result.type }}</div>
        <div class="search-result-description" *ngIf="result.description">
          {{ result.description }}
        </div>
      </div>
    </div>
  </div>

  <div class="actions-section">
    <button class="add-button" (click)="addNewItem()" *ngIf="!editingItem && !isNewItem">
      Add New Library Item
    </button>
  </div>

  <div class="recent-items-section" *ngIf="showRecentItems && !editingItem && !isNewItem && recentItems.length > 0">
    <h3>Recently Modified (Last 50)</h3>
    <div class="recent-items-list">
      <div
        *ngFor="let item of recentItems"
        class="recent-item"
        (click)="editItem(item)"
      >
        <div class="item-guid-badge">{{ item.guid }}</div>
        <div class="item-info">
          <div class="item-name">{{ item.name }}</div>
          <div class="item-details">
            <span class="item-type">Type: {{ item.type }}</span>
            <span class="item-separator">•</span>
            <span class="item-modified" *ngIf="item.modified">
              Modified: {{ item.modified | date:'short' }}
            </span>
          </div>
          <div class="item-description" *ngIf="item.description">
            {{ item.description }}
          </div>
        </div>
        <button
          *ngIf="hasDeletePermission()"
          class="delete-item-btn"
          (click)="deleteItemFromList(item); $event.stopPropagation()"
          title="Delete item"
        >
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="edit-section" *ngIf="editingItem || isNewItem">
    <div class="edit-form">
      <h2>{{ isNewItem ? 'Add New Library Item' : 'Edit Library Item' }}</h2>

      <div class="form-group">
        <label for="itemName">Name *</label>
        <input
          id="itemName"
          type="text"
          class="form-control"
          [(ngModel)]="itemName"
          placeholder="Enter item name"
        />
      </div>

      <div class="form-group">
        <label for="itemDescription">Description</label>
        <input
          id="itemDescription"
          type="text"
          class="form-control"
          [(ngModel)]="itemDescription"
          placeholder="Enter item description (optional)"
        />
      </div>

      <div class="form-group">
        <label for="itemType">Type *</label>
        <select
          id="itemType"
          class="form-control"
          [(ngModel)]="itemType"
          (change)="onTypeChange()"
        >
          <option value="text">Text</option>
          <option value="image">Image</option>
          <option value="url">URL</option>
        </select>
      </div>

      <!-- Text Type Content -->
      <div class="form-group" *ngIf="itemType === 'text'">
        <label>Content Pages</label>
        <div class="pages-container">
          <div *ngFor="let page of textPages; let i = index" class="page-item">
            <div class="page-header">
              <span class="page-number">Page {{ page.page }}</span>
              <button
                *ngIf="textPages.length > 1"
                class="remove-page-btn"
                (click)="removePage(page.page)"
                title="Remove page"
              >
                ×
              </button>
            </div>
            <textarea
              class="form-control page-content"
              [(ngModel)]="page.content"
              placeholder="Enter content for page {{ page.page }}"
              rows="5"
            ></textarea>
          </div>
          <button class="add-page-btn" (click)="addPage()">Add Page</button>
        </div>
      </div>

      <!-- Image Type Content -->
      <div class="form-group" *ngIf="itemType === 'image'">
        <label>Image File *</label>
        <input
          type="file"
          class="form-control"
          accept="image/*"
          (change)="onImageFileSelected($event)"
        />
        <div *ngIf="imagePreview" class="image-preview">
          <img [src]="imagePreview" alt="Preview" />
        </div>
      </div>

      <!-- URL Type Content -->
      <div class="form-group" *ngIf="itemType === 'url'">
        <label for="urlContent">URL *</label>
        <input
          id="urlContent"
          type="url"
          class="form-control"
          [(ngModel)]="urlContent"
          placeholder="Enter URL (e.g., https://example.com)"
        />
      </div>

      <div class="form-actions">
        <button class="save-button" (click)="saveItem()">Save</button>
        <button class="cancel-button" (click)="cancelEdit()">Cancel</button>
        <button 
          *ngIf="!isNewItem && editingItem && hasDeletePermission()" 
          class="delete-button" 
          (click)="deleteItem()"
        >
          Delete
        </button>
      </div>
    </div>
  </div>

  <app-error-popup
    [message]="errorMessage"
    [show]="showError"
    (close)="closeErrorPopup()"
  ></app-error-popup>

  <app-confirm-dialog
    [title]="confirmDialogTitle"
    [message]="confirmDialogMessage"
    [show]="showConfirmDialog"
    confirmText="Delete"
    cancelText="Cancel"
    confirmColor="danger"
    (confirm)="onConfirmDelete()"
    (cancel)="closeConfirmDialog()"
    (close)="closeConfirmDialog()"
  ></app-confirm-dialog>
</div>
